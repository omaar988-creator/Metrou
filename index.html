<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metrou: Ø±Ø­Ù„Ø© ØªØ¹Ù„Ù… Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© ğŸš‡</title>
    <style>
        body { background: #121212; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; padding: 20px; }
        .station-container { display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap; }
        .station-node { 
            background: #1e1e1e; border: 3px solid #4CAF50; border-radius: 50%; 
            width: 80px; height: 80px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; cursor: pointer; transition: 0.3s;
        }
        .station-node.locked { border-color: #555; opacity: 0.6; cursor: not-allowed; }
        .station-node:hover:not(.locked) { transform: scale(1.1); background: #2e7d32; }
        .lesson-card { background: #1e1e1e; padding: 20px; border-radius: 15px; max-width: 600px; margin: 20px auto; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .btn-explain { background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-size: 18px; font-weight: bold; }
        #explanation-text { text-align: right; line-height: 1.6; color: #ddd; margin-top: 20px; white-space: pre-line; }
    </style>
</head>
<body>

    <h1>ØªØ·Ø¨ÙŠÙ‚ Metrou ğŸš‡</h1>
    <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø·Ø© Ù„ØªØ¨Ø¯Ø£ Ø¯Ø±Ø³ Ø§Ù„Ù„ØºØ© Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</p>

    <div class="station-container" id="metro-map">

    <div id="inspector-section" class="lesson-card" style="border: 2px dashed #f44336; display: none;">
    <div style="font-size: 50px;">ğŸ‘®â€â™‚ï¸</div>
    <h3 style="color: #f44336;">ØªÙØªÙŠØ´ Ù…ÙØ§Ø¬Ø¦! (ContrÃ´le)</h3>
    <p id="inspection-question">Ø£Ø¸Ù‡Ø± ØªØ°ÙƒØ±ØªÙƒ Ø§Ù„Ù„ØºÙˆÙŠØ©.. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ:</p>
    <div id="inspection-content" style="background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 10px;"></div>
    <button class="btn-explain" style="background: #f44336;" onclick="closeInspection()">ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø£Ùˆ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø¨ ğŸ˜…)</button>
</div>

<script>
    // ÙˆØ¸ÙŠÙØ© ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙØªÙŠØ´ Ø¹Ø´ÙˆØ§Ø¦ÙŠØ§Ù‹
    async function startInspection() {
        const inspectorDiv = document.getElementById('inspector-section');
        const contentDiv = document.getElementById('inspection-content');
        
        inspectorDiv.style.display = 'block';
        contentDiv.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙØªØ´... ğŸƒâ€â™‚ï¸";

        try {
            const res = await fetch(`${API_URL}/api/ai/inspect`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ past_topics: ["Ø§Ù„ØªØ­ÙŠØ§Øª", "Ø§Ù„Ø£Ø±Ù‚Ø§Ù…", "Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ¹Ø±ÙŠÙ"] })
            });
            const data = await res.json();
            contentDiv.innerText = data.inspection_query;
        } catch (e) {
            contentDiv.innerText = "Ù‡Ù†Ø§Ùƒ Ø²Ø­Ø§Ù… ÙÙŠ Ø§Ù„Ù…Ø­Ø·Ø©ØŒ Ø§Ù„Ù…ÙØªØ´ Ù„Ù† ÙŠØ£ØªÙŠ Ø§Ù„Ø¢Ù†!";
        }
    }

    function closeInspection() {
        document.getElementById('inspector-section').style.display = 'none';
    }

    // Ø¬Ø¹Ù„ Ø§Ù„ØªÙØªÙŠØ´ ÙŠØ¸Ù‡Ø± ÙØ¬Ø£Ø© ÙƒÙ„ ÙØªØ±Ø©
    setTimeout(startInspection, 15000); // Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ØªÙØªÙŠØ´ Ø¨Ø¹Ø¯ 15 Ø«Ø§Ù†ÙŠØ© Ù…Ù† ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ÙƒÙ…Ø«Ø§Ù„
</script>

        </div>

    <div class="lesson-card">
        <h3 id="current-lesson">Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©</h3>
        <button class="btn-explain" onclick="askGemini()">Ø·Ù„Ø¨ Ø´Ø±Ø­ Ù…Ù† Gemini âœ¨</button>
        <div id="explanation-text">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø´Ø±Ø­ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ù„Ùƒ...</div>
    </div>

    <script>
        const API_URL = "https://metrou-db.onrender.com";

        // ØªØ­Ù…ÙŠÙ„ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø·Ø§Øª Ù…Ù† ÙƒÙˆØ¯ Ø§Ù„Ø¨Ø§ÙŠØ«ÙˆÙ†
        async function loadMap() {
            try {
                const res = await fetch(`${API_URL}/api/metro/map`);
                const stations = await res.json();
                const mapDiv = document.getElementById('metro-map');
                mapDiv.innerHTML = stations.map(s => `
                    <div class="station-node ${s.status === 'locked' ? 'locked' : ''}" onclick="selectStation('${s.name_ar}', '${s.name_fr}')">
                        <span style="font-size: 20px;">${s.status === 'locked' ? 'ğŸ”’' : 'ğŸš‡'}</span>
                        <small style="font-size: 10px;">${s.name_ar}</small>
                    </div>
                `).join('');
            } catch (e) { console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø±ÙŠØ·Ø©"); }
        }

        let currentTopic = "Ø§Ù„ØªØ­ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©";

        function selectStation(nameAr, nameFr) {
            document.getElementById('current-lesson').innerText = `Ø§Ù„Ù…Ø­Ø·Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${nameAr} (${nameFr})`;
            currentTopic = `${nameAr} ÙÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©`;
            document.getElementById('explanation-text').innerText = "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø´Ø±Ø­...";
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù€ Gemini (Ø§Ù„Ø°ÙŠ Ø±Ø¨Ø·Ù†Ø§Ù‡ ÙÙŠ Ù…Ù„Ù server.py)
        async function askGemini() {
            const textDiv = document.getElementById('explanation-text');
            textDiv.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ (Gemini)... ğŸ§ ";
            
            try {
                const res = await fetch(`${API_URL}/api/ai/explain`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ topic: currentTopic })
                });
                const data = await res.json();
                textDiv.innerText = data.explanation;
            } catch (err) {
                textDiv.innerText = "ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ÙØªØ§Ø­ Gemini ÙÙŠ Render.";
            }
        }

        loadMap();
    </script>
</body>
</html>
            border-radius: 25px;
            margin-top: 20px;
            width: 100%;
            cursor: pointer;
        }
        .status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #888;
        }
        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }
        .online { background-color: #2e7d32; color: white; }
        .offline { background-color: #c62828; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>Metrou App ğŸš‡</h1>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØªØ·Ø¨ÙŠÙ‚ Ù…ØªØ±Ùˆ Ù„ØªØ¹Ù„Ù… Ø§Ù„Ù„ØºØ§Øª</p>
        
        <div id="server-status">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¹Ù‚Ù„... ğŸ”„
        </div>
    </div>

    <div class="card">
        <h3>Ø§Ø®ØªØ¨Ø± Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</h3>
        <button onclick="testAI()">Ø´Ø±Ø­ Ù‚Ø§Ø¹Ø¯Ø© (ØªØ¬Ø±Ø¨Ø©)</button>
        <p id="ai-response" style="margin-top: 15px; color: #4fc3f7;"></p>
    </div>
</div>

<script>
    // Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const BACKEND_URL = "https://metrou-db.onrender.com";

    // Ø¯Ø§Ù„Ø© Ù„ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ ÙÙˆØ± ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    async function checkServer() {
        const statusDiv = document.getElementById('server-status');
        try {
            const response = await fetch(`${BACKEND_URL}/api/health`);
            const data = await response.json();
            
            if (data.status === "ok") {
                statusDiv.innerHTML = '<span class="badge online">Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…ØªØµÙ„ âœ…</span>';
            }
        } catch (error) {
            statusDiv.innerHTML = '<span class="badge offline">ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ âŒ</span><br><small>ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ÙŠØ¹Ù…Ù„</small>';
            console.error(error);
        }
    }

    // Ø¯Ø§Ù„Ø© Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø²Ø±
    async function testAI() {
        const resultDiv = document.getElementById('ai-response');
        resultDiv.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±... ğŸ¤”";
        
        try {
            const response = await fetch(`${BACKEND_URL}/api/ai/explain`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ topic: "Le Present", user_language: "ar" })
            });
            const data = await response.json();
            resultDiv.innerText = data.explanation;
        } catch (error) {
            resultDiv.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„!";
        }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    checkServer();
</script>

</body>
</html>
<div class="lesson-card" style="border-bottom: 2px solid #4CAF50; margin-bottom: 30px;">
    <h3>ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
    <input type="text" id="username-input" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." 
           style="padding: 10px; border-radius: 5px; border: none; width: 60%;">
    <button onclick="changeName()" 
            style="padding: 10px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…
    </button>
    <p id="welcome-msg" style="color: #4CAF50; font-weight: bold; margin-top: 10px;"></p>
</div>

<script>
    // ÙˆØ¸ÙŠÙØ© ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
    async function changeName() {
        const name = document.getElementById('username-input').value;
        if (!name) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø£ÙˆÙ„Ø§Ù‹");

        try {
            const res = await fetch(`${API_URL}/api/user/update-name`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name })
            });
            const data = await res.json();
            document.getElementById('welcome-msg').innerText = data.message;
            // Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­ Ù„ÙŠØ¨Ù‚Ù‰ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
            localStorage.setItem('user_name', name);
        } catch (e) {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
        }
    }

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    window.onload = () => {
        const savedName = localStorage.getItem('user_name');
        if (savedName) {
            document.getElementById('welcome-msg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ØŒ ${savedName} ğŸš‡`;
        }
        loadMap(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    };
</script>

